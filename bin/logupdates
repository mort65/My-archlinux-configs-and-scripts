#!/usr/bin/env sh
#this script log available arch linux updates

USERNAME=${SUDO_USER:-$(id -u -n)}
HOMEDIR="/home/$USERNAME"

#enabling notify-send for cron
export DISPLAY=:0.0
# shellcheck source=/dev/null
if [ -r "$HOMEDIR/.dbus/Xdbus" ]; then
  . "$HOMEDIR/.dbus/Xdbus"
fi

TITLE="System Update"
MSG=""
CDATE=$(/usr/bin/date "+%a %b %d %H:%M")
COMMAND="$( (/usr/bin/checkupdates; /usr/bin/yay -Qu 2>/dev/null) | /usr/bin/sort -u | /usr/bin/wc -l)"

case $COMMAND in
	''|*[!0-9]*)
		exit 1
		;;
	*)
		if [ "$COMMAND" -ne "0" ]; then
			if [ "$COMMAND" -eq "1" ]; then
				MSG="an update is available"
			elif [ "$COMMAND" -gt "1" ]; then
				MSG="$COMMAND updates are available"
			else
				exit 1
			fi

			if [ "$XDG_CURRENT_DESKTOP" = "KDE" ]; then
				#/usr/bin/notify-send --expire-time=0 "$TITLE" "\- $CDATE \-\n$MSG" --icon=software-update-available
				/usr/bin/notify-send --expire-time=30000 "$TITLE" "\- $CDATE \-\n$MSG" --icon=software-update-available
			else
				/usr/bin/notify-send --expire-time=30000 "$TITLE" "\- $CDATE \-\n$MSG" --icon=software-update-available
			fi
			echo "$COMMAND" > "$HOMEDIR/.number_of_updates.txt"
		else
			#clear content of the file
			/usr/bin/truncate -s 0 "$HOMEDIR/.number_of_updates.txt"
		fi
		;;
esac

exit 0
